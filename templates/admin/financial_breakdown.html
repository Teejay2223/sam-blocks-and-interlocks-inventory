{% extends 'base.html' %}
{% block title %}Financial Breakdown{% endblock %}
{% block content %}
<h3 class="mb-3">Financial Breakdown & Analysis</h3>

<!-- Date Range Filter -->
<div class="card mb-4">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Start Date</label>
        <input type="date" name="start" class="form-control" value="{{ start }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">End Date</label>
        <input type="date" name="end" class="form-control" value="{{ end }}">
      </div>
      <div class="col-md-3">
        <button type="submit" class="btn btn-primary w-100">Update Period</button>
      </div>
      <div class="col-md-3">
        <a href="{{ url_for('admin_expenses') }}" class="btn btn-outline-secondary w-100">Manage Expenses</a>
      </div>
    </form>
  </div>
</div>

<!-- Summary Cards -->
<div class="row gy-3 mb-4">
  <div class="col-md-3">
    <div class="card p-3 h-100 bg-success text-white">
      <h6 class="mb-0">Revenue</h6>
      <div class="display-6">{{ "%.2f"|format(revenue) }}</div>
      <small>Sales in period</small>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card p-3 h-100 bg-danger text-white">
      <h6 class="mb-0">Expenses</h6>
      <div class="display-6">{{ "%.2f"|format(expenses) }}</div>
      <small>Total costs</small>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card p-3 h-100 {% if profit >= 0 %}bg-primary{% else %}bg-warning{% endif %} text-white">
      <h6 class="mb-0">Profit</h6>
      <div class="display-6">{{ "%.2f"|format(profit) }}</div>
      <small>Net income</small>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card p-3 h-100 bg-info text-white">
      <h6 class="mb-0">Margin</h6>
      <div class="display-6">{{ "%.1f"|format(profit_margin) }}%</div>
      <small>Profit margin</small>
    </div>
  </div>
</div>

<!-- Charts -->
<div class="row gy-3 mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h6 class="card-title">Revenue & Expenses (Last 6 Months)</h6>
        <canvas id="revenueExpensesChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h6 class="card-title">Expenses by Category ({{ start }} to {{ end }})</h6>
        <canvas id="expensesCategoryChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Top Expenses Table -->
<div class="card mb-4">
  <div class="card-body">
    <h6 class="card-title">Top 10 Expenses in Period</h6>
    {% if top_expenses %}
    <div class="table-responsive">
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Date</th>
            <th>Category</th>
            <th>Description</th>
            <th class="text-end">Amount</th>
          </tr>
        </thead>
        <tbody>
          {% for e in top_expenses %}
          <tr>
            <td>{{ e['date'] if 'date' in e.keys() else e.date }}</td>
            <td><span class="badge bg-secondary">{{ e['category'] if 'category' in e.keys() else e.category }}</span></td>
            <td>{{ e['description'] if 'description' in e.keys() else e.description }}</td>
            <td class="text-end"><strong>{{ "%.2f"|format(e['amount'] if 'amount' in e.keys() else e.amount) }}</strong></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="alert alert-info mb-0">No expenses recorded in this period.</div>
    {% endif %}
  </div>
</div>

<div class="mb-3">
  <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">‚Üê Back to Dashboard</a>
  <a href="{{ url_for('sales_report') }}" class="btn btn-outline-primary">Sales Report</a>
</div>

<script>
// Revenue & Expenses Line Chart
(function() {
  const monthlyRev = {{ monthly_revenue|tojson }};
  const monthlyExp = {{ monthly_expenses|tojson }};
  
  // Build unified month list
  const allMonths = new Set();
  monthlyRev.forEach(r => allMonths.add(r.month));
  monthlyExp.forEach(e => allMonths.add(e.month));
  const months = Array.from(allMonths).sort();
  
  const revData = months.map(m => {
    const found = monthlyRev.find(r => r.month === m);
    return found ? found.total : 0;
  });
  const expData = months.map(m => {
    const found = monthlyExp.find(e => e.month === m);
    return found ? found.total : 0;
  });
  
  const ctx = document.getElementById('revenueExpensesChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: months,
      datasets: [
        {
          label: 'Revenue',
          data: revData,
          borderColor: 'rgb(40, 167, 69)',
          backgroundColor: 'rgba(40, 167, 69, 0.1)',
          tension: 0.3
        },
        {
          label: 'Expenses',
          data: expData,
          borderColor: 'rgb(220, 53, 69)',
          backgroundColor: 'rgba(220, 53, 69, 0.1)',
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { position: 'top' }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
})();

// Expenses by Category Pie Chart
(function() {
  const expByCat = {{ expenses_by_cat|tojson }};
  const categories = expByCat.map(e => e.category);
  const amounts = expByCat.map(e => e.total);
  
  const ctx = document.getElementById('expensesCategoryChart').getContext('2d');
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: categories,
      datasets: [{
        data: amounts,
        backgroundColor: [
          'rgb(255, 99, 132)',
          'rgb(54, 162, 235)',
          'rgb(255, 205, 86)',
          'rgb(75, 192, 192)',
          'rgb(153, 102, 255)',
          'rgb(255, 159, 64)',
          'rgb(201, 203, 207)'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { position: 'right' }
      }
    }
  });
})();
</script>
{% endblock %}
