{% extends 'base.html' %}
{% block title %}Expenses Management{% endblock %}
{% block content %}
<h3 class="mb-3">Expenses Management</h3>

<!-- Add Expense Form -->
<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title">Record New Expense</h5>
    <form method="post">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Date</label>
          <input type="date" name="date" class="form-control" value="{{ request.form.get('date', '') }}" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Category</label>
          <input type="text" name="category" class="form-control" list="category-list" placeholder="e.g., Transport, Materials" required>
          <datalist id="category-list">
            {% for cat in categories %}
            <option value="{{ cat }}">
            {% endfor %}
          </datalist>
        </div>
        <div class="col-md-3">
          <label class="form-label">Amount</label>
          <input type="number" step="0.01" name="amount" class="form-control" placeholder="0.00" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Payment Method</label>
          <input type="text" name="payment_method" class="form-control" placeholder="Cash, Bank, Mobile">
        </div>
        <div class="col-md-6">
          <label class="form-label">Description</label>
          <input type="text" name="description" class="form-control" placeholder="Brief description">
        </div>
        <div class="col-md-3">
          <label class="form-label">Receipt #</label>
          <input type="text" name="receipt_number" class="form-control" placeholder="Optional">
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">Add Expense</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Filters -->
<div class="card mb-3">
  <div class="card-body">
    <h6 class="card-title">Filters</h6>
    <form method="get" class="row g-2">
      <div class="col-md-3">
        <label class="form-label">Category</label>
        <select name="category" class="form-select">
          <option value="">All Categories</option>
          {% for cat in categories %}
          <option value="{{ cat }}" {% if cat_filter == cat %}selected{% endif %}>{{ cat }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Start Date</label>
        <input type="date" name="start" class="form-control" value="{{ start or '' }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">End Date</label>
        <input type="date" name="end" class="form-control" value="{{ end or '' }}">
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-secondary w-100">Apply Filters</button>
      </div>
    </form>
  </div>
</div>

<!-- Expenses List -->
<h5>Recorded Expenses</h5>
{% if expenses %}
<div class="table-responsive">
  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>Date</th>
        <th>Category</th>
        <th>Description</th>
        <th>Amount</th>
        <th>Payment</th>
        <th>Receipt #</th>
        <th>By</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for e in expenses %}
      <tr>
        <td>{{ e['date'] if 'date' in e.keys() else e.date }}</td>
        <td><span class="badge bg-secondary">{{ e['category'] if 'category' in e.keys() else e.category }}</span></td>
        <td>{{ e['description'] if 'description' in e.keys() else e.description }}</td>
        <td class="text-end"><strong>{{ "%.2f"|format(e['amount'] if 'amount' in e.keys() else e.amount) }}</strong></td>
        <td>{{ e['payment_method'] if 'payment_method' in e.keys() else e.payment_method }}</td>
        <td>{{ e['receipt_number'] if 'receipt_number' in e.keys() else e.receipt_number }}</td>
        <td class="small text-muted">{{ e['created_by'] if 'created_by' in e.keys() else e.created_by }}</td>
        <td>
          <a href="{{ url_for('admin_expenses_edit', eid=e['id'] if 'id' in e.keys() else e.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
          <form method="post" action="{{ url_for('admin_expenses_delete', eid=e['id'] if 'id' in e.keys() else e.id) }}" class="d-inline" onsubmit="return confirm('Delete this expense?')">
            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="alert alert-info">No expenses recorded yet. Add one above.</div>
{% endif %}

<div class="mt-3">
  <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">‚Üê Back to Dashboard</a>
  <a href="{{ url_for('admin_financial_breakdown') }}" class="btn btn-primary">View Financial Breakdown</a>
</div>
{% endblock %}
